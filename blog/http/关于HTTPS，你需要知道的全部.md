# 关于HTTPS，你需要知道的全部

首先来看一种场景：小红发信息约小明放学后去电影。

正常的信息流动是这样的：

1.小红 -> *放学后去看电影吧？* -> 小明
2.小明 -> *好，校门口等我。* ->  小红

但如果存在一个中间人把小红和小明的信息拦截，并做了修改，信息流变成了下面这样：

1.小红 -> *放学后去看电影吧？*-> 中间人（你） -> *今天上课有点累，放学我就回家了，不要等我。* -> 小明
2.小明 -> *好吧，好好休息。* -> 中间人（你） -> *不去了，放学后我就回家。* -> 小明

小红以为小明不陪自己看电影，小明以为小红放学就回家了，而你就找了个理由约上小红去看电影了。

之所以会产生误解，是因为小红和小明没办法验证对方信息的真假，都以为收到了对方的正确信息，这是个典型的[中间人攻击](https://zh.wikipedia.org/wiki/%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB)的例子。

HTTPS正是要解决这个问题，在HTTP传输层之上加了一个安全层（SSL或TLS协议实现），可以做到以下3点：

* **数据的保密性**
* **校验双方身份的真实性**
* **数据的完整性**

下面来看https是如果解决这3个问题的。

# 一、数据的保密性

数据要保密，就需要对数据进行加密。加密算法可以分为2类，一类是对称加密算法，另一类是非对称加密算法。

**对称加密算法**，加密和解密使用相同的密钥，优点是加密速度快，缺点是如果密钥泄露的话就无法做到保密了。常见的对称加密算法有DES、AES等。

**非对称加密算法**，又叫公开密钥加密。需要有2个密钥，公钥和私钥，公钥向所有人公开，私钥不公开。用公钥加密的数据只有私钥才能解密；反之，用私钥加密的数据只有公钥才能解密。因为这种特性，非对称加密算法可以用来校验数字签名，下面会具体讲解。

很显然，仅使用对称加密算法是不现实的，互联网中通信的双方大多是临时建立的连接，不可能提前协商好密钥，而且密钥也要进行传输，无法保证密钥本身的安全性。

如果使用非对称加密，客户端向服务器发送数据是安全的，客户端用服务器的公钥进行加密，只有服务器用自己的私钥才能解密。但如果服务器用私钥对数据进行加密，则所有人都可以用公钥进行解密，这是不安全的。

HTTPS的解决方案是这样的：**用非对称算法随机加密出一个对称密钥，然后双方用对称密钥进行通信。**具体来说，就是客户端生成一个随机密钥，用服务器的公钥对这个密钥进行非对称加密，服务器用私钥进行解密，然后双方就用这个对称密钥来进行数据加密了。

# 二、校验双方身份的真实性

上面说了加密，保证了数据不能被他人读取，但通信的双方怎样校验对方的身份呢？HTTPS使用了[数字证书](https://zh.wikipedia.org/wiki/%E9%9B%BB%E5%AD%90%E8%AD%89%E6%9B%B8)，数字证书就是身份认证机构（Certificate Authority）盖在数字身份证上的一个章或印（或者说加在数字身份证上的一个签名），这一行为表示身份认证机构已认定这个人。证书的合法性可以向CA验证。

数字证书主要包含以下信息：
* 证书颁发机构
* 证书颁发机构签名
* 证书绑定的服务器域名
* 证书版本、有效期
* 签名使用的加密算法（非对称算法，如RSA）
* 公钥

客户端收到服务器的响应后，先向CA验证证书的合法性（根据证书的签名、绑定的域名等信息），如果校验不通过，浏览器会中止连接，向用户提示证书不安全。

需要提一点的是，证书的制作方法是公开的，任何人都可以自己制作证书，所以有些公司不向CA申请，比如12306。但自己制作的证书是得不到CA认证的，所以访问12306网站时，浏览器会有证书不合法的提示，如下图，只有用户选择信任该网站时，才能继续访问。

![证书校验不合法提示](http://upload-images.jianshu.io/upload_images/2438937-b84376e13ada4a1f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

# 三、数据的完整性

网络传输过程中需要经过很多中间节点，虽然数据无法被解密，但可能被篡改，那如何校验数据的完整性呢？通过校验数字签名，流程见下图：

![数字签名校验](http://upload-images.jianshu.io/upload_images/2438937-bd85d0ac6a75e5c1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

首先来了解下[哈希算法](https://zh.wikipedia.org/wiki/%E6%95%A3%E5%88%97%E5%87%BD%E6%95%B8)，哈希算法能够将任意长度的字符串转化为固定长度的字符串，该过程不可逆，可用来作数据完整性校验。

**服务器在发送报文之前做了3件的事：**
* 用哈希算法对报文提取定长摘要
* 用私钥对摘要进行加密，作为数字签名
* 将数字签名附加到报文末尾发送给客户端

**客户端接收到报文后：**
* 用公钥对服务器的数字签名进行解密
* 用同样的算法重新计算出报文的数字签名
* 比较解密后的签名与自己计算的签名是否一致，如果不一致，说明数据被篡改过。

同样，客户端发送数据时，通过公钥加密报文摘要，服务器用私钥解密，用同样的方法校验数据的完整性。

# HTTPS通信的大致过程

![HTTPS通信过程](http://upload-images.jianshu.io/upload_images/2438937-1bed618480b4d12b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

1. 客户端将自己支持的加密算法发送给服务器，请求服务器证书；

2. 服务器选取一组加密算法，并将证书返回给客户端；

3. 客户端校验证书合法性，生成随机对称密钥，用公钥加密后发送给服务器；

4. 服务器用私钥解密出对称密钥，返回一个响应，HTTPS连接建立完成；

5. 随后双方通过这个对称密钥进行安全的数据通信。

# 思考

通过HTTPS，客户端一旦发现证书不合法或者数据被篡改，就是中止连接，文章开头说的中间人攻击就无效了。

<br>
下一篇介绍[抓包工具是如何抓取HTTPS请求的?][1]